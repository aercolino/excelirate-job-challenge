<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1">

  <title>Shopping Cart</title>
  <meta name="description"
        content="A simple shopping cart for adding and removing units of selected items and applying discounts">
  <meta name="author"
        content="aercolino@yahoo.com">

  <link rel="stylesheet"
        href="index.css">

  <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
          integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI="
          crossorigin="anonymous"></script>
  <script>
    jQuery(function ($) {
      'use strict';

      function createRowsFromProducts(products) {
        const template$ = $('.cart-row.template');
        products.forEach((product) => {
          const newRow$ = template$.clone().removeClass('template');
          newRow$.find('.data').each(function () {
            const data$ = $(this);
            if (data$.is('.name')) data$.text(product.name);
            if (data$.is('.code')) data$.text(product.code);
            if (data$.is('.price')) data$.text(product.price / 100);
          });
          newRow$.appendTo('.cart-table');
        });
      }

      function getData(context$, key) {
        return context$.find(`.data.${key}`).text();
      }

      function getComputed(context$, key) {
        return context$.find(`.computed.${key}`).text();
      }

      function setComputed(context$, key, value) {
        context$.find(`.computed.${key}`).text(value);
      }

      function sum(array) {
        return array.reduce((acc, val) => acc + val, 0);
      }

      function updateRow(row$, units) {
        setComputed(row$, 'units', units);
        const price = parseFloat(getData(row$, 'price'));
        const total = units * price;
        setComputed(row$, 'total', total);
        updateSummary();
      }

      function updateItems() {
        const units = $('.units', $('.cart-row:not(.template)')).map(function() {
          return parseInt($(this).text(), 10);
        }).get();
        const items = sum(units);
        const summary$ = $('.summary');
        setComputed(summary$, 'items', items);
      }

      function updateItemsTotal() {
        const totals = $('.total', $('.cart-row:not(.template)')).map(function() {
          return parseFloat($(this).text());
        }).get();
        const itemsTotal = sum(totals);
        const summary$ = $('.summary');
        setComputed(summary$, 'itemsTotal', itemsTotal);
      }

      function makeCart() {
        const selected$ = $('.cart-row:not(.template').filter(function() {
          const row$ = $(this);
          const units = parseInt(getComputed(row$, 'units'), 10);
          return units > 0;
        });
        const result = selected$.map(function () {
          const row$ = $(this);
          const units = parseInt(getComputed(row$, 'units'), 10);
          const price = Math.floor(parseFloat(getData(row$, 'price')) * 100);
          const total = Math.floor(parseFloat(getComputed(row$, 'total')) * 100);
          return {
            code: getData(row$, 'code'),
            units,
            price,
            total,
          }
        }).get();
        return result;
      }

      function applyDiscounts() {
        const cart = makeCart();
        console.log(cart);
      }

      function updateGrandTotal() {
        const summary$ = $('.summary');
        const grandTotal = getComputed(summary$, 'itemsTotal');
        setComputed(summary$, 'grandTotal', grandTotal);
      }

      function updateSummary() {
        updateItems();
        updateItemsTotal();
        applyDiscounts();
        updateGrandTotal();
      }

      function attachHandlerForDecrementingUnits() {
        const minuses$ = $('.minus');
        minuses$.on('click', function () {
          const button$ = $(this);
          const row$ = button$.parents('.cart-row');
          const units = parseInt(getComputed(row$, 'units'), 10);
          if (units === 0) return;
          updateRow(row$, units - 1);
        });
      }

      function attachHandlerForIncrementingUnits() {
        const pluses$ = $('.plus');
        pluses$.on('click', function () {
          const button$ = $(this);
          const row$ = button$.parents('.cart-row');
          const units = parseInt(getComputed(row$, 'units'), 10);
          updateRow(row$, units + 1);
        });
      }

      console.log(`Using jQuery ${$.fn.jquery}`);

      const products = [
        {
          code: 'GOKU',
          name: 'Goku POP',
          price: 500,
        },
        {
          code: 'NARU',
          name: 'Naruto POP',
          price: 2000,
        },
        {
          code: 'LUF',
          name: 'Luffy POP',
          price: 750,
        },
      ];

      const discounts = [
        {
          name: '2x1 Goku POP offer',
          value: (cart) => Math.floor(cart['GOKU'].units / 2) * cart['GOKU'].price,
        },
        {
          name: 'x3 Naruto POP offer',
          value: (cart) => cart['NARU'].units >= 3 ? cart['NARU'].units * 100 : 0,
        }
      ];

      createRowsFromProducts(products);
      attachHandlerForDecrementingUnits();
      attachHandlerForIncrementingUnits();
    });
  </script>
</head>

<body>
  <div class="p-8 bg-gray-900">
    <div class="max-w-3xl mx-auto flex flex-col sm:flex-row border rounded">
      <div class="p-4 bg-white sm:w-4/6 divide-y-2 divide-gray-200">
        <div class="mb-2">
          <h2 class="font-semibold text-xl">Shopping Cart</h2>
        </div>
        <div class="py-4">
          <table class="cart-table table-fixed w-full">
            <thead>
              <tr>
                <th class="w-3/6 text-left">Product Details</th>
                <th class="w-1/6">Quantity</th>
                <th class="w-1/6">Price</th>
                <th class="w-1/6">Total</th>
              </tr>
            </thead>
            <tbody>
              <tr class="cart-row template">
                <td>
                  <h3 class="font-bold text-purple-600"><span class="data name">Goku POP</span></h3>
                  <p class="text-xs">Product code <span class="data code">GOKU</span></p>
                </td>
                <td class="text-center">
                  <div class="flex flex-row justify-center">
                    <div class="mr-1 py-1"><button class="text-purple-600 minus">-</button></div>
                    <div class="w-8 py-1 border-2 rounded"><span class="computed units">0</span></div>
                    <div class="ml-1 py-1"><button class="text-purple-600 plus">+</button></div>
                  </div>
                </td>
                <td class="text-center"><span class="data price"></span> €</td>
                <td class="text-center"><span class="computed total">0</span> €</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="p-4 bg-gray-200 sm:w-2/6 divide-y-2 divide-gray-300 summary">
        <div class="mb-2">
          <h2 class="text-xl font-semibold">Order Summary</h2>
        </div>
        <div class="flex flex-col divide-y divide-gray-300">
          <div class="py-4">
            <table class="table-fixed w-full">
              <tbody>
                <tr>
                  <td class="text-gray-600"><span class="computed items">0</span> Items</td>
                  <td class="text-right font-bold"><span class="computed itemsTotal">0</span> €</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="py-4 discounts" style="display: none;">
            <div class="mb-2">
              <h2 class="uppercase text-gray-400">Discounts</h2>
            </div>
            <table class="table-fixed w-full">
              <tbody>
                <tr class="discount-row template">
                  <td class="text-gray-600"><span class="computed discountName"></span></td>
                  <td class="text-right font-bold"><span class="computed discountValue">0</span> €</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="py-4">
            <table class="table-fixed w-full">
              <tbody>
                <tr>
                  <td class="uppercase text-gray-600">Total Cost</td>
                  <td class="text-xl text-right font-bold"><span class="computed grandTotal">0</span> €</td>
                </tr>
              </tbody>
            </table>
          </div>
          <button class="py-3 my-3 text-center bg-purple-600 text-white bordr rounded">
            Checkout
          </button>
        </div>
      </div>
    </div>
  </div>
  <script type="module"
          src="/src/main.js"></script>
</body>

</html>
